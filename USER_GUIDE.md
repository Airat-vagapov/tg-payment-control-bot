# –†—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: tg-payment-control-bot

## –ß—Ç–æ —ç—Ç–æ

`tg-payment-control-bot` ‚Äî Telegram-–±–æ—Ç –¥–ª—è –∫–æ–Ω—Ç—Ä–æ–ª—è –µ–∂–µ–º–µ—Å—è—á–Ω—ã—Ö –ø–ª–∞—Ç–µ–∂–µ–π –≤ –≥—Ä—É–ø–ø–µ:
- —Å–æ–∑–¥–∞–µ—Ç —Å—á–µ—Ç —É—á–∞—Å—Ç–Ω–∏–∫—É –∑–∞ —Ç–µ–∫—É—â–∏–π –ø–µ—Ä–∏–æ–¥;
- –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Å—Ç–∞—Ç—É—Å –æ–ø–ª–∞—Ç—ã;
- –≤ —Ç–µ—Å—Ç–æ–≤–æ–º —Ä–µ–∂–∏–º–µ —É–º–µ–µ—Ç –æ—Ç–º–µ—á–∞—Ç—å –æ–ø–ª–∞—Ç—É –∫–∞–∫ –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω—É—é;
- –≤ –º–æ–º–µ–Ω—Ç –¥–µ–¥–ª–∞–π–Ω–∞ –∑–∞–ø—É—Å–∫–∞–µ—Ç –ø—Ä–æ–≤–µ—Ä–∫—É –∏ –ø—Ä–∏–º–µ–Ω—è–µ—Ç —Å–∞–Ω–∫—Ü–∏—é –¥–ª—è –¥–æ–ª–∂–Ω–∏–∫–∞.

## –¢—Ä–µ–±–æ–≤–∞–Ω–∏—è

- Node.js 20+ (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –∞–∫—Ç—É–∞–ª—å–Ω—ã–π LTS)
- Docker (–¥–ª—è –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ PostgreSQL)
- Telegram-–±–æ—Ç (—Ç–æ–∫–µ–Ω –æ—Ç BotFather)

## –ë—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç

### 1) –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏

```bash
npm install
```

### 2) –ü–æ–¥–Ω–∏–º–∏—Ç–µ PostgreSQL

```bash
docker compose up -d db
```

### 3) –ó–∞–ø–æ–ª–Ω–∏—Ç–µ `.env`

–û–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ:

- `BOT_TOKEN` ‚Äî —Ç–æ–∫–µ–Ω Telegram-–±–æ—Ç–∞
- `DATABASE_URL` ‚Äî —Å—Ç—Ä–æ–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ PostgreSQL

–†–µ–∫–æ–º–µ–Ω–¥—É–µ–º—ã–µ/–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–µ:

- `PORT` (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é `3000`)
- `DEFAULT_AMOUNT_CENTS` (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é `50000`)
- `DEFAULT_TZ` (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é `Europe/Berlin`)
- `DEFAULT_DUE_DAY` (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é `5`)
- `DEFAULT_DUE_HOUR` (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é `18`)
- `ALLOWED_GROUP_CHAT_ID` (–µ—Å–ª–∏ –∑–∞–¥–∞–Ω, –±–æ—Ç —Ä–∞–±–æ—Ç–∞–µ—Ç —Ç–æ–ª—å–∫–æ –≤ —ç—Ç–æ–π –≥—Ä—É–ø–ø–µ)
- `WEBHOOK_BASE_URL` (–¥–ª—è –±—É–¥—É—â–µ–≥–æ webhook-—Å—Ü–µ–Ω–∞—Ä–∏—è)
- `TEST_DUE_IN_MINUTES` (—Ç–æ–ª—å–∫–æ –¥–ª—è —Ç–µ—Å—Ç–∞: –¥–µ–¥–ª–∞–π–Ω —á–µ—Ä–µ–∑ N –º–∏–Ω—É—Ç)

–ü—Ä–∏–º–µ—Ä `DATABASE_URL`:

```env
DATABASE_URL=postgresql://postgres:postgres@localhost:5432/tgpay
```

### 4) –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–π—Ç–µ —Å—Ö–µ–º—É –ë–î

```bash
npm run prisma:push
```

### 5) –ó–∞–ø—É—Å—Ç–∏—Ç–µ –±–æ—Ç–∞

```bash
npm run dev
```

## –ö–∞–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è –≤ Telegram

### `/setup` (–≤ –≥—Ä—É–ø–ø–µ, –æ–±—ã—á–Ω–æ –∞–¥–º–∏–Ω)

–ü–æ–¥–∫–ª—é—á–∞–µ—Ç —Ç–µ–∫—É—â—É—é –≥—Ä—É–ø–ø—É –∫ –±–æ—Ç—É –∏ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç –±–∞–∑–æ–≤—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏:
- —Å—É–º–º–∞ –ø–ª–∞—Ç–µ–∂–∞;
- —Ç–∞–π–º–∑–æ–Ω–∞;
- –¥–µ–Ω—å/—á–∞—Å –¥–µ–¥–ª–∞–π–Ω–∞.

### `/groups` (–≤ –ª–∏—á–∫–µ —Å –±–æ—Ç–æ–º)

–ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç –≥—Ä—É–ø–ø—ã, –≥–¥–µ –≤—ã –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω—ã, –∏ –ø–æ–∑–≤–æ–ª—è–µ—Ç –≤—ã–±—Ä–∞—Ç—å —Ç–µ–∫—É—â—É—é –≥—Ä—É–ø–ø—É –¥–ª—è –æ–ø–ª–∞—Ç—ã/—Å—Ç–∞—Ç—É—Å–∞.

### `/pay` (–≤ –ª–∏—á–∫–µ —Å –±–æ—Ç–æ–º)

–°–æ–∑–¥–∞–µ—Ç (–∏–ª–∏ –Ω–∞—Ö–æ–¥–∏—Ç —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π) —Å—á–µ—Ç –∑–∞ —Ç–µ–∫—É—â–∏–π –º–µ—Å—è—Ü –∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –∫–Ω–æ–ø–∫–∏:
- `üí≥ –û–ø–ª–∞—Ç–∏—Ç—å` ‚Äî –≤ —Ç–µ–∫—É—â–µ–π –≤–µ—Ä—Å–∏–∏ —Å–æ–∑–¥–∞–µ—Ç mock-–ø–ª–∞—Ç–µ–∂ —Å–æ —Å—Ç–∞—Ç—É—Å–æ–º `pending`;
- `‚úÖ –¢–µ—Å—Ç: –æ—Ç–º–µ—Ç–∏—Ç—å –æ–ø–ª–∞—á–µ–Ω–æ` ‚Äî –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ —Å—Ç–∞–≤–∏—Ç –æ–ø–ª–∞—Ç—É –≤ `paid` (–¥–ª—è —Ç–µ—Å—Ç–∞).

### `/status` (–≤ –ª–∏—á–∫–µ —Å –±–æ—Ç–æ–º)

–ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Å–æ—Å—Ç–æ—è–Ω–∏–µ —Å—á–µ—Ç–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∑–∞ —Ç–µ–∫—É—â–∏–π –ø–µ—Ä–∏–æ–¥:
- `unpaid`, `pending`, `paid`, `excused`, `kicked`.

## –ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç –¥–µ–¥–ª–∞–π–Ω

- –ü—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ —Å—á–µ—Ç–∞ –±–æ—Ç —Å—Ç–∞–≤–∏—Ç –æ—Ç–ª–æ–∂–µ–Ω–Ω—É—é –∑–∞–¥–∞—á—É (`pg-boss`) –Ω–∞ –≤—Ä–µ–º—è `dueAt`.
- –í –º–æ–º–µ–Ω—Ç –¥–µ–¥–ª–∞–π–Ω–∞ –∑–∞–¥–∞—á–∞ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç —Å—á–µ—Ç:
  - –µ—Å–ª–∏ `paid`/`excused` ‚Äî –Ω–∏—á–µ–≥–æ –Ω–µ –¥–µ–ª–∞–µ—Ç;
  - –µ—Å–ª–∏ –Ω–µ –æ–ø–ª–∞—á–µ–Ω ‚Äî –ø—Ä–∏–º–µ–Ω—è–µ—Ç —Å–∞–Ω–∫—Ü–∏—é (kick) –∏ –ø–∏—à–µ—Ç –∞—É–¥–∏—Ç.
- –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–µ —Ü–∏–∫–ª–∏—á–µ—Å–∫–∞—è: —ç—Ç–æ –æ–¥–Ω–æ—Ä–∞–∑–æ–≤–∞—è –∑–∞–¥–∞—á–∞ –Ω–∞ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π —Å—á–µ—Ç.

## –¢–µ—Å—Ç–æ–≤—ã–π —Å—Ü–µ–Ω–∞—Ä–∏–π (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è)

1. –ü–æ—Å—Ç–∞–≤—å—Ç–µ `TEST_DUE_IN_MINUTES=2` –≤ `.env`.
2. –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç–µ `npm run dev`.
3. –û—Ç–∫—Ä–æ–π—Ç–µ –ª–∏—á–Ω—ã–π —á–∞—Ç —Å –±–æ—Ç–æ–º –∏ –Ω–∞–∂–º–∏—Ç–µ `Start`.
4. –í –≥—Ä—É–ø–ø–µ –≤—ã–ø–æ–ª–Ω–∏—Ç–µ `/setup`.
5. –í –ª–∏—á–∫–µ –≤—ã–ø–æ–ª–Ω–∏—Ç–µ `/groups` –∏ –≤—ã–±–µ—Ä–∏—Ç–µ –Ω—É–∂–Ω—É—é –≥—Ä—É–ø–ø—É.
6. –í –ª–∏—á–∫–µ –≤—ã–ø–æ–ª–Ω–∏—Ç–µ `/pay`.
4. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ:
   - –≤–∞—Ä–∏–∞–Ω—Ç A: –Ω–∞–∂–∞—Ç—å `‚úÖ –¢–µ—Å—Ç: –æ—Ç–º–µ—Ç–∏—Ç—å –æ–ø–ª–∞—á–µ–Ω–æ` –∏ –¥–æ–∂–¥–∞—Ç—å—Å—è –¥–µ–¥–ª–∞–π–Ω–∞ (—Å–∞–Ω–∫—Ü–∏–∏ –Ω–µ –±—É–¥–µ—Ç);
   - –≤–∞—Ä–∏–∞–Ω—Ç B: –Ω–∏—á–µ–≥–æ –Ω–µ –Ω–∞–∂–∏–º–∞—Ç—å –∏ –¥–æ–∂–¥–∞—Ç—å—Å—è –¥–µ–¥–ª–∞–π–Ω–∞ (—Å—Ä–∞–±–æ—Ç–∞–µ—Ç —Å–∞–Ω–∫—Ü–∏—è).

## –ü–æ–ª–µ–∑–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã

- –ó–∞–ø—É—Å–∫ –≤ dev: `npm run dev`
- –°–±–æ—Ä–∫–∞: `npm run build`
- –ó–∞–ø—É—Å–∫ —Å–æ–±—Ä–∞–Ω–Ω–æ–π –≤–µ—Ä—Å–∏–∏: `npm run start`
- –ü—Ä–∏–º–µ–Ω–∏—Ç—å —Å—Ö–µ–º—É –ë–î: `npm run prisma:push`
- Prisma Studio: `npm run prisma:studio`

## –ß–∞—Å—Ç—ã–µ –ø—Ä–æ–±–ª–µ–º—ã

- –ë–æ—Ç –Ω–µ –æ—Ç–≤–µ—á–∞–µ—Ç –≤ –≥—Ä—É–ø–ø–µ:
  - –ø—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ –±–æ—Ç –¥–æ–±–∞–≤–ª–µ–Ω –≤ –≥—Ä—É–ø–ø—É;
  - –ø—Ä–æ–≤–µ—Ä—å—Ç–µ `ALLOWED_GROUP_CHAT_ID` (–º–æ–∂–µ—Ç –±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å —á—É–∂–∏–µ —á–∞—Ç—ã);
  - —É–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –≤ –≥—Ä—É–ø–ø–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ `/setup`.

- –ë–æ—Ç –Ω–µ –æ—Ç–≤–µ—á–∞–µ—Ç –≤ –ª–∏—á–∫–µ:
  - —Å–Ω–∞—á–∞–ª–∞ –æ—Ç–∫—Ä–æ–π—Ç–µ –¥–∏–∞–ª–æ–≥ —Å –±–æ—Ç–æ–º –∏ –Ω–∞–∂–º–∏—Ç–µ `Start`;
  - –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–æ–º–∞–Ω–¥—ã `/groups`, `/pay`, `/status` —Ç–æ–ª—å–∫–æ –≤ –ª–∏—á–∫–µ.

- –û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ –ë–î:
  - –ø—Ä–æ–≤–µ—Ä—å—Ç–µ `DATABASE_URL`;
  - –ø—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä `db` –ø–æ–¥–Ω—è—Ç (`docker compose ps`).

- –°–∞–Ω–∫—Ü–∏—è –Ω–µ —Å—Ä–∞–±–æ—Ç–∞–ª–∞:
  - –ø—Ä–æ–≤–µ—Ä—å—Ç–µ –ø—Ä–∞–≤–∞ –±–æ—Ç–∞ –≤ –≥—Ä—É–ø–ø–µ (–¥–æ–ª–∂–µ–Ω —É–º–µ—Ç—å –±–∞–Ω–∏—Ç—å/–∫–∏–∫–∞—Ç—å);
  - –ø—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ –ø—Ä–æ—Ü–µ—Å—Å–∞ (`npm run dev`), —Ç–∞–º –ø–∏—à—É—Ç—Å—è —Å–æ–±—ã—Ç–∏—è –¥–∂–æ–±.

## –í–∞–∂–Ω–æ –ø—Ä–æ –ø—Ä–æ–¥–∞–∫—à–µ–Ω

–°–µ–π—á–∞—Å –ø—Ä–æ–µ–∫—Ç –æ—Ä–∏–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω –Ω–∞ –ª–æ–∫–∞–ª—å–Ω—É—é/—Ç–µ—Å—Ç–æ–≤—É—é —ç–∫—Å–ø–ª—É–∞—Ç–∞—Ü–∏—é:
- –≤ `index.ts` –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è long polling (`bot.start()`);
- endpoint `/payments/webhook` –ø–æ–∫–∞ –∑–∞–≥–ª—É—à–∫–∞;
- —Ä–µ–∞–ª—å–Ω—ã–π –ø–ª–∞—Ç–µ–∂–Ω—ã–π –ø—Ä–æ–≤–∞–π–¥–µ—Ä –µ—â–µ –Ω–µ –ø–æ–¥–∫–ª—é—á–µ–Ω.
